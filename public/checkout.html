<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:opsz@6..12&display=swap" rel="stylesheet" />

  <!-- SDK de Clip -->
  <script src="https://sdk.clip.mx/js/clip-sdk.js"></script>

  <style>
    /* ===== RESET / BODY ===== */
    body {
      font-family: 'Nunito Sans', Arial, sans-serif;
      min-height: 100vh;
      margin: 0;
      background: radial-gradient(circle at top,
          #2a0000 0%,
          #0b0b0b 45%,
          #000 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      /* compacto para WebView */
    }

    /* ===== FORM CONTAINER ===== */
    form {
      width: 100%;
      max-width: 420px;
      background: #111;
      border-radius: 20px;
      padding: 18px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
    }

    /* ===== CHECKOUT (Clip Card) ===== */
    #checkout {
      width: 100%;
      height: 195px;
      /* ðŸ”‘ elimina el espacio negro */
      margin-bottom: 12px;
      /* distancia corta al botÃ³n */
      overflow: hidden;
      border-radius: 14px;
    }

    /* Iframe del SDK de Clip */
    #checkout iframe {
      width: 100% !important;
      height: 195px !important;
      min-height: 195px !important;
      max-height: 195px !important;
      border-radius: 14px;
      display: block;
    }

    /* Evita mÃ¡rgenes internos que mete el SDK */
    #checkout * {
      margin: 0 !important;
      padding: 0 !important;
    }

    /* ===== BOTÃ“N PRINCIPAL ===== */
    button {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 999px;
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.3px;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(135deg,
          #b00000 0%,
          #ff1a1a 100%);
      box-shadow:
        0 8px 25px rgba(255, 0, 0, 0.45),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
      transition: all 0.2s ease;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow:
        0 12px 35px rgba(255, 0, 0, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.25);
    }

    button:disabled {
      background: #444;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* ===== TOKEN INFO ===== */
    #cardTokenId {
      margin-top: 8px;
      font-size: 12px;
      color: #aaa;
      text-align: center;
      word-break: break-all;
    }

    /* ===== AJUSTE PARA TELÃ‰FONOS ALTOS ===== */
    @media (min-height: 750px) {

      #checkout,
      #checkout iframe {
        height: 205px !important;
        min-height: 205px !important;
        max-height: 205px !important;
      }
    }
  </style>

</head>

<body>
  <form id="payment-form">
    <div id="checkout"></div>
    <button id="submit">Procesar Pago</button>
    <p id="cardTokenId"></p>
  </form>

  <script>
    const API_KEY = "ac12a9b5-4bc7-4ec3-8d86-fd5edd2aeb6b";
    const BACKEND_URL = "https://api.mobile.slan.mx/api/v1";

    const urlParams = new URLSearchParams(window.location.search);
    const paymentId = urlParams.get('paymentId');

    if (!paymentId) {
      alert('Payment ID is required in the URL');
      document.querySelector('#submit').disabled = true;
    }

    const clip = new ClipSDK(API_KEY);

    const card = clip.element.create("Card", {
      theme: "dark",
      locale: "es",
    });

    card.mount("checkout");

    document
      .querySelector("#payment-form")
      .addEventListener("submit", async (event) => {
        event.preventDefault();

        const submitButton = document.querySelector('#submit');
        submitButton.disabled = true;
        submitButton.textContent = 'Procesando...';

        try {
          const cardToken = await card.cardToken();
          const cardTokenID = cardToken.id;

          document.querySelector('#cardTokenId').textContent =
            `Token: ${cardTokenID}`;

          const response = await fetch(
            `${BACKEND_URL}/payments/process/${paymentId}`,
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ card_token: cardTokenID }),
            }
          );

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || 'Error processing payment');
          }

          alert('Pago procesado exitosamente!');
        } catch (error) {
          alert("Error procesando pago: " + error.message);
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = 'Procesar Pago';
        }
      });
  </script>
</body>

</html>