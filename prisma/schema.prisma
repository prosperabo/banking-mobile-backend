generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Users {
  id                         Int                        @id @default(autoincrement())
  email                      String                     @unique
  password                   String
  phone                      String?
  completeName               String?                    @db.VarChar(255)
  gender                     Gender
  birthDate                  DateTime
  birthCountry               String?                    @db.VarChar(255)
  curp                       String
  postalCode                 String?                    @db.VarChar(255)
  state                      String
  country                    String?                    @db.VarChar(255)
  municipality               String
  street                     String
  colony                     String
  externalNumber             String
  internalNumber             String
  contractLink               String?
  pin                        String?
  cardType                   String?
  creditLinePreference       String?
  cardUsage                  String?
  occupation                 String?
  sector                     String?
  mainActivity               String?
  monthlyIncome              Float?
  monthlyOutcome             Float?
  hasOtherCreditCards        Boolean?
  documentScan               String?
  universityRegistration     Int?
  creditLimit                Float?
  interestRate               Float?
  paymentDates               String?
  initialDeposit             Float?
  depositReceipt             String?
  universityProfilePhotoLink String?
  rfc                        String?
  createdAt                  DateTime                   @default(now())
  firstName                  String?                    @db.VarChar(255)
  lastName                   String?                    @db.VarChar(255)
  secondLastName             String?                    @db.VarChar(255)
  nationality                String?                    @db.VarChar(255)
  countryCode                String?                    @db.VarChar(10)
  monthlyIncomeRange         String?                    @db.VarChar(255)
  isUniversityStudent        Boolean                    @default(false)
  alias                      String?                    @unique(map: "ux_users_alias") @db.VarChar(255)
  AcademicInformation        AcademicInformation?
  BackofficeAuthState        BackofficeAuthState?
  BackofficeCustomerProfile  BackofficeCustomerProfile?
  Cards                      Cards[]
  completedLessons           CompletedLesson[]
  Transactions               Transactions[]
  payments                   payments[]
}

model VerifiedEmails {
  id         Int      @id @default(autoincrement())
  email      String   @unique
  verifiedAt DateTime @default(now())
}

model Module {
  id      Int      @id @default(autoincrement())
  index   Int
  lessons Lesson[]
}

model Lesson {
  id          Int               @id @default(autoincrement())
  index       Int
  moduleId    Int
  completions CompletedLesson[]
  module      Module            @relation(fields: [moduleId], references: [id])

  @@index([moduleId], map: "Lesson_moduleId_fkey")
}

model CompletedLesson {
  id        Int      @id @default(autoincrement())
  userId    Int
  lessonId  Int
  passed    Boolean
  createdAt DateTime @default(now())
  lesson    Lesson   @relation(fields: [lessonId], references: [id])
  user      Users    @relation(fields: [userId], references: [id])

  @@index([lessonId], map: "CompletedLesson_lessonId_fkey")
  @@index([userId], map: "CompletedLesson_userId_fkey")
}

model BackofficeAuthState {
  id                         Int      @id @default(autoincrement())
  userId                     Int      @unique
  clientState                Int      @default(9)
  deviceId                   String
  privateKey                 String
  refreshToken               String
  extraLoginData             String?
  lastCustomerOauthToken     String?
  oauthExpirationTimestamp   String?
  refreshExpirationTimestamp String?
  externalCustomerId         Int?
  ewalletId                  Int?
  defaultBalanceId           Int?
  lastCardId                 Int?
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @default(now())
  Users                      Users    @relation(fields: [userId], references: [id])
}

model BackofficeCustomerProfile {
  id                                Int      @id @default(autoincrement())
  userId                            Int      @unique
  account_level                     Int?
  account_status                    Int?
  account_status_string             String?
  address                           String?
  address_document_back             String?
  address_document_back_url         String?
  address_document_front            String?
  address_document_front_url        String?
  address_document_type             Int?
  are_account_resources_of_user     Boolean?
  business_name                     String?
  business_purpose                  String?
  ciabe                             String?
  city                              String?
  colony                            String?
  constitution_date                 String?
  correspondence_address            String?
  country_of_birth                  String?
  date_of_birth                     String?
  ecommerce_id                      Int?
  email                             String?
  exterior                          String?
  first_name                        String?
  gender                            Int?
  gender_string                     String?
  external_customer_id              Int?
  identification_document_back      String?
  identification_document_back_url  String?
  identification_document_front     String?
  identification_document_front_url String?
  identification_document_type      Int?
  interior                          String?
  is_business                       Boolean?
  last_name                         String?
  mobile                            String?
  mobile_country_code               String?
  nationality_id                    Int?
  oauth_token                       String?
  occupation_id                     Int?
  person_type                       Int?
  private_key                       String?
  rfc                               String?
  refresh_token                     String?
  risk_level                        Int?
  second_last_name                  String?
  society_type                      Int?
  selfie                            String?
  selfie_url                        String?
  state_id                          Int?
  street                            String?
  telephone                         String?
  zipcode                           String?
  ewallet_id                        Int?
  ewallet_status                    Int?
  createdAt                         DateTime @default(now())
  updatedAt                         DateTime @default(now())
  Users                             Users    @relation(fields: [userId], references: [id])
}

model Cards {
  id             Int            @id @default(autoincrement())
  userId         Int
  bulkBatchId    Int?
  prosperaCardId String?        @unique
  cardType       Cards_cardType
  cardIdentifier String         @unique
  status         Cards_status   @default(ACTIVE)
  encryptedPin   String?
  maskedNumber   String?
  expiryDate     String?
  cvv            String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime
  BulkBatch      BulkBatch?     @relation(fields: [bulkBatchId], references: [id])
  Users          Users          @relation(fields: [userId], references: [id])
  Transactions   Transactions[]

  @@index([userId], map: "Cards_userId_fkey")
  @@index([bulkBatchId])
}

model Transactions {
  id                    Int                 @id @default(autoincrement())
  userId                Int
  cardId                Int?
  type                  Transactions_type
  amount                Decimal             @db.Decimal(10, 2)
  externalTransactionId String?
  status                Transactions_status
  description           String?
  prosperaReference     String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime
  Cards                 Cards?              @relation(fields: [cardId], references: [id])
  Users                 Users               @relation(fields: [userId], references: [id])

  @@index([cardId], map: "Transactions_cardId_fkey")
  @@index([userId], map: "Transactions_userId_fkey")
}

model BulkBatch {
  id             Int       @id @default(autoincrement())
  referenceBatch String    @unique
  status         Int?
  numCreated     Int?
  numFailed      Int?
  requestedAt    DateTime  @default(now())
  receivedAt     DateTime?
  Cards          Cards[]
}

model AcademicInformation {
  id                         Int                               @id @default(autoincrement())
  userId                     Int                               @unique
  academicArea               AcademicInformation_academicArea?
  actualSemester             Int?
  scholarshipPercentage      Int?
  scholarshipPercentageRange String?                           @db.VarChar(255)
  Users                      Users                             @relation(fields: [userId], references: [id])
}

model payments {
  id                  BigInt          @id @default(autoincrement()) @db.UnsignedBigInt
  user_id             Int
  order_id            String?         @db.VarChar(64)
  provider            String          @db.VarChar(32)
  provider_payment_id String?         @db.VarChar(100)
  amount              Decimal         @db.Decimal(10, 2)
  currency            String          @default("MXN") @db.Char(3)
  description         String?         @db.VarChar(255)
  business_fee_rate   Decimal         @default(0.00) @db.Decimal(5, 2)
  business_fee_amount Decimal         @default(0.00) @db.Decimal(10, 2)
  net_amount          Decimal         @default(0.00) @db.Decimal(10, 2)
  status              payments_status @default(PENDING)
  payment_method      String          @db.VarChar(32)
  payment_token       String?         @db.VarChar(150)
  idempotency_key     String          @unique(map: "uk_payments_idempotency") @db.VarChar(100)
  request_payload     Json?
  response_payload    Json?
  created_at          DateTime        @default(now()) @db.DateTime(0)
  updated_at          DateTime        @default(now()) @db.DateTime(0)
  Users               Users           @relation(fields: [user_id], references: [id], map: "fk_payments_user")

  @@unique([provider, provider_payment_id], map: "uk_payments_provider_payment")
  @@index([order_id], map: "idx_payments_order")
  @@index([provider], map: "idx_payments_provider")
  @@index([user_id], map: "idx_payments_user")
}

enum Gender {
  MASCULINO
  FEMENINO
}

enum Cards_cardType {
  VIRTUAL
  PHYSICAL
}

enum Transactions_type {
  TOPUP
  DEDUCT
  REVERSAL
  ADJUSTMENT
  BALANCE_INQUIRY
}

enum Cards_status {
  ACTIVE
  BLOCKED
  INACTIVE
  EXPIRED
}

enum Transactions_status {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum AcademicInformation_academicArea {
  STEM
  NEGOCIOS_ECONOMIA
  SALUD
  CIENCIAS_SOCIALES
  ARTES_HUMANIDADES
  EDUCACION
  DERECHO
}

enum payments_status {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}
